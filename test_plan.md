# 测试计划 - 验证搜索修复效果

## 测试目标

验证相似度计算修复后，文字检索的关联度是否显著提升。

## 测试环境

- Python 3.12.3
- LanceDB（默认使用余弦距离）
- CLIP模型（使用余弦相似度）
- 相似度阈值：0.3（已修复）

## 测试步骤

### 1. 单元测试：相似度计算公式

**目标**：验证相似度计算公式是否正确

**测试文件**：`check_lancedb_distance.py`

**运行命令**：
```bash
python3 check_lancedb_distance.py
```

**预期结果**：
- 距离0.0 → 相似度1.0
- 距离0.1 → 相似度0.9
- 距离0.3 → 相似度0.7
- 距离0.5 → 相似度0.5
- 距离0.7 → 相似度0.3
- 距离1.0 → 相似度0.0

**通过标准**：所有距离值的相似度转换符合预期

---

### 2. 集成测试：搜索功能

**目标**：验证搜索结果的相关性是否提升

**前提条件**：
- 向量库中已索引一些测试数据（图片、视频等）
- 测试查询词应该与索引内容相关

**测试查询**：
1. "猫" - 应该返回猫的图片/视频
2. "老虎" - 应该返回老虎的图片/视频
3. "风景" - 应该返回风景图片
4. "人物" - 应该返回人物图片

**运行命令**：
```bash
# 使用WebUI测试
python3 -m src.webui.app

# 或使用API测试
curl -X POST http://localhost:8000/api/v1/search/text \
  -H "Content-Type: application/json" \
  -d '{"query": "猫", "top_k": 10}'
```

**预期结果**：
- 每个查询都应该返回相关度较高的结果
- 高度相关的结果（相似度>0.7）应该排在前面
- 相似度值应该在0.0-1.0范围内

**通过标准**：
- 至少50%的结果与查询词相关
- 最高相似度>0.7
- 平均相似度>0.5

---

### 3. 性能测试：搜索响应时间

**目标**：验证搜索性能是否符合要求

**性能要求**：
- 搜索响应时间 ≤ 2秒（前20个结果）

**运行命令**：
```bash
# 使用性能测试脚本
python3 scripts/benchmark.py
```

**预期结果**：
- 搜索响应时间 ≤ 2秒
- 相似度计算不影响性能

**通过标准**：满足性能要求

---

### 4. 回归测试：其他搜索类型

**目标**：确保修复不影响其他搜索类型

**测试项目**：
1. 图像搜索（图搜图）
2. 音频搜索
3. 视频搜索

**运行命令**：
```bash
# 测试图像搜索
curl -X POST http://localhost:8000/api/v1/search/image \
  -H "Content-Type: application/json" \
  -d '{"image_path": "/path/to/test/image.jpg", "top_k": 10}'

# 测试音频搜索
curl -X POST http://localhost:8000/api/v1/search/audio \
  -H "Content-Type: application/json" \
  -d '{"audio_path": "/path/to/test/audio.mp3", "top_k": 10}'
```

**预期结果**：
- 所有搜索类型都能正常工作
- 相似度计算正确
- 结果相关性高

**通过标准**：所有搜索类型通过测试

---

### 5. 边界测试：极端情况

**目标**：验证系统在极端情况下的表现

**测试场景**：
1. 空查询：`""` - 应该返回错误或空结果
2. 无关查询：`"xyz123"` - 应该返回低相似度结果或空结果
3. 大量查询：连续执行100次搜索 - 应该稳定运行
4. 大批量结果：`top_k=100` - 应该正确返回100个结果

**预期结果**：
- 系统能够正确处理极端情况
- 不会崩溃或出现异常
- 相似度值始终在[0,1]范围内

**通过标准**：所有边界场景通过测试

---

### 6. 数据一致性测试

**目标**：验证相似度计算的一致性

**测试方法**：
1. 对同一查询执行多次搜索
2. 验证返回结果的相似度分数是否一致
3. 验证结果排序是否一致

**预期结果**：
- 多次搜索的相似度分数相同
- 结果排序一致

**通过标准**：相似度分数和排序一致

---

## 测试报告模板

### 测试环境
- 操作系统：Linux 6.8.0-90-generic
- Python版本：3.12.3
- LanceDB版本：0.26.1
- CLIP模型：chinese-clip-vit-base-patch16

### 测试结果

| 测试项 | 状态 | 通过标准 | 实际结果 | 备注 |
|--------|------|----------|----------|------|
| 相似度计算公式 | ⬜ | 所有距离值转换正确 | - | - |
| 搜索功能 | ⬜ | 至少50%结果相关 | - | - |
| 性能测试 | ⬜ | 响应时间≤2秒 | - | - |
| 图像搜索 | ⬜ | 正常工作 | - | - |
| 音频搜索 | ⬜ | 正常工作 | - | - |
| 视频搜索 | ⬜ | 正常工作 | - | - |
| 空查询 | ⬜ | 正确处理 | - | - |
| 无关查询 | ⬜ | 返回低相似度 | - | - |
| 大量查询 | ⬜ | 稳定运行 | - | - |
| 数据一致性 | ⬜ | 结果一致 | - | - |

### 问题记录

| 序号 | 问题描述 | 严重程度 | 状态 | 解决方案 |
|------|----------|----------|------|----------|
| - | - | - | - | - |

### 总结

**通过率**：0/10 (0%)

**总体评价**：待测试

**建议**：执行测试计划并更新结果

---

## 执行计划

1. **第1天**：执行单元测试和集成测试
2. **第2天**：执行性能测试和回归测试
3. **第3天**：执行边界测试和数据一致性测试
4. **第4天**：分析测试结果，修复发现的问题
5. **第5天**：重新测试，确保所有问题已解决

---

## 验收标准

**系统通过验收的条件**：
- ✅ 所有测试项通过（通过率100%）
- ✅ 无严重问题（严重程度：高）
- ✅ 中等问题数量 ≤ 2
- ✅ 搜索结果相关性显著提升（平均相似度>0.5）
- ✅ 性能符合要求（响应时间≤2秒）

---

**注意**：在测试过程中，如果发现任何问题，请立即记录并在"问题记录"表中跟踪解决进度。
# CI环境优化测试配置
# 针对GitHub Actions CI环境优化，解决依赖和资源限制问题

# 设备配置 - 强制使用CPU
device: "cpu"
force_cpu: true
disable_gpu: true

# 模型配置 - 使用轻量级模型和优化设置
model:
  # 使用较小的CLIP模型，减少内存使用
  clip_model: "openai/clip-vit-base-patch32"
  # 禁用GPU加速的人脸模型
  face_model: "mtcnn"
  # 模型缓存目录
  cache_dir: "./data/models"
  # 启用模型量化以减少内存使用
  quantization: true
  # 禁用模型下载，使用模拟数据
  mock_models: true

# 批处理配置 - 减小批处理大小
batch_size: 1  # 最小批处理大小
max_batch_size: 2

# 内存优化配置
memory:
  # 最大内存使用限制 (MB) - CI环境通常限制较严
  max_memory_mb: 1536
  # 启用内存清理
  enable_gc: true
  # GC触发阈值
  gc_threshold: 50
  # 定期内存清理间隔(秒)
  cleanup_interval: 10

# 测试数据限制 - 减小测试数据大小
test_data:
  # 视频时长限制 (秒)
  max_video_duration: 30
  # 图片分辨率限制
  max_image_resolution: [320, 240]
  # 音频时长限制 (秒)
  max_audio_duration: 15
  # 最大文件大小 (MB)
  max_file_size_mb: 10
  # 使用模拟数据而非真实文件
  use_mock_data: true

# 性能基准 - CPU模式调整期望值
performance_benchmarks:
  # 视频处理速度 (实时倍数) - CI环境较慢
  video_processing_fps: 0.1
  # 搜索响应时间 (毫秒)
  search_response_time_ms: 2000
  # 内存使用限制 (MB)
  memory_usage_mb: 1536
  # 时间戳精度要求 (秒) - 放宽要求
  timestamp_accuracy_s: 3.0

# Qdrant配置 - 使用模拟模式
qdrant:
  # 使用模拟模式，避免真实连接
  mock_mode: true
  host: "localhost"
  port: 6333
  # 连接超时
  timeout: 10
  # 重试次数
  max_retries: 1
  # 集合配置
  collection_config:
    # 向量维度
    vector_size: 512
    # 距离度量
    distance: "Cosine"
    # 优化器配置
    optimizers_config:
      # 删除阈值
      deleted_threshold: 0.2
      # 真空最小向量数
      vacuum_min_vector_number: 1000
      # 默认段数
      default_segment_number: 0
      # 最大段大小
      max_segment_size_kb: 5000
      # 内存映射阈值
      memmap_threshold_kb: 1000
      # 索引阈值
      indexing_threshold_kb: 2000
      # 刷新间隔
      flush_interval_sec: 5
      # 最大优化线程数
      max_optimization_threads: 1

# 日志配置 - 减少日志输出
logging:
  level: "WARNING"  # 减少日志输出
  # 日志文件
  file: "logs/ci_test.log"
  # 最大文件大小 (MB)
  max_file_size_mb: 5
  # 备份文件数
  backup_count: 1
  # 日志格式
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  # 禁用详细日志
  verbose: false

# OpenCV配置 - CI环境特殊设置
opencv:
  # 禁用GUI相关功能
  headless: true
  # 线程数限制
  num_threads: 1
  # 禁用硬件加速
  disable_opencl: true
  # 禁用多线程
  disable_multithreading: true

# 测试超时配置 - 缩短超时时间
timeouts:
  # 单个测试超时 (秒)
  test_timeout: 120
  # 服务启动超时 (秒)
  service_startup_timeout: 30
  # 网络请求超时 (秒)
  request_timeout: 10
  # 模型加载超时 (秒)
  model_load_timeout: 30

# 并发配置 - 减少并发
concurrency:
  # 最大并发数
  max_workers: 1
  # 线程池大小
  thread_pool_size: 2
  # 禁用并行测试
  parallel_tests: false

# 错误处理配置
error_handling:
  # 最大重试次数
  max_retries: 2
  # 重试间隔 (秒)
  retry_interval: 1
  # 启用详细错误日志
  verbose_errors: false
  # 快速失败模式
  fast_fail: true

# 测试环境配置
test_environment:
  # 临时目录
  temp_dir: "/tmp/msearch_test"
  # 测试数据目录
  fixtures_dir: "tests/fixtures"
  # 输出目录
  output_dir: "tests/output"
  # 清理临时文件
  cleanup_temp: true
  # 使用内存文件系统(如果可用)
  use_memory_fs: true

# 依赖检查配置
dependency_check:
  # 必需的Python包
  required_packages:
    - numpy
    - opencv-python
    - pytest
    - fastapi
  # 可选的Python包
  optional_packages:
    - torch
    - transformers
    - qdrant-client
  # 系统依赖检查
  check_system_deps: true
  # 依赖检查超时(秒)
  check_timeout: 30

# CI特定配置
ci:
  # 启用CI模式
  enabled: true
  # 跳过耗时测试
  skip_slow_tests: true
  # 跳过网络相关测试
  skip_network_tests: true
  # 跳过GPU相关测试
  skip_gpu_tests: true
  # 生成测试报告
  generate_report: true
  # 报告格式
  report_format: "json"
  # 报告输出路径
  report_path: "test_results.json"